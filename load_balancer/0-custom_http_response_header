#!/usr/bin/env bash
# Configure Nginx with a custom X-Served-By header and a simple index on a fresh Ubuntu

set -euo pipefail
# shellcheck disable=SC2154

export DEBIAN_FRONTEND=noninteractive

sudo apt-get update -y
sudo apt-get install -y nginx

# Ensure a basic index page exists
sudo mkdir -p /var/www/html
printf 'Hello from %s\n' "$(hostname)" | sudo tee /var/www/html/index.html >/dev/null

# Add a global header from the server hostname
# Using conf.d which is included by default in /etc/nginx/nginx.conf on Ubuntu 16.04
sudo mkdir -p /etc/nginx/conf.d
cat <<'EOF' | sudo tee /etc/nginx/conf.d/custom_headers.conf >/dev/null
# Add a response header to identify which server handled the request
# Works in the http context so it applies to all server blocks
add_header X-Served-By $hostname;
EOF

# Make sure default site serves from /var/www/html
if [ -f /etc/nginx/sites-available/default ]; then
  sudo sed -i 's|try_files.*$|try_files $uri $uri/ =404;|g' /etc/nginx/sites-available/default
fi

# Validate and reload Nginx
sudo nginx -t
sudo systemctl enable nginx
sudo systemctl restart nginx
